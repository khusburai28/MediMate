{{define "dashboard.html"}}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MediMate - Dashboard</title>
  <link rel="stylesheet" href="/static/css/style.css">
  <link rel="stylesheet" href="/static/css/responsive.css">
  <link rel="stylesheet" href="/static/css/chat.css">
  <script src="/static/js/chat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="container">
      <div class="logo">
        <h1><i class="fas fa-heartbeat pulse"></i> MediMate</h1>
      </div>
      <div class="nav-links" id="navLinks">
        <i class="fas fa-times" id="closeMenu"></i>
        <ul>
          <li><a href="/">Home</a></li>
          <li><a href="/dashboard" class="active">Dashboard</a></li>
          <li><a href="/#about">About</a></li>
          <li><a href="/#contact">Contact</a></li>
        </ul>
      </div>
      <div class="auth-buttons">
        {{if .User}}
          <span class="user-info">Logged in as: {{.User}}</span>
          <a href="/logout" class="btn btn-secondary">Logout</a>
        {{else}}
          <a href="/login" class="btn btn-primary">Login</a>
          <a href="/register" class="btn btn-primary">Sign Up</a>
        {{end}}
      </div>
      <i class="fas fa-bars" id="menuIcon"></i>
    </div>
  </nav>

  <section class="dashboard-section py-5" style="padding-top: 120px;">
    <div class="container">
      <h2 class="mb-4">Welcome to Your Prescription Dashboard</h2>

      <!-- Upload Prescription Card -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h3 class="m-0 font-weight-bold">Upload Prescription</h3>
        </div>
        <div class="card-body">
          <form id="prescriptionForm" action="/analyze-prescription" method="post" enctype="multipart/form-data" onsubmit="handlePrescriptionSubmit(event)">
            <div class="upload-area" id="uploadArea">
              <i class="fas fa-file-medical fa-3x mb-3"></i>
              <h4>Drag & Drop or Click to Upload</h4>
              <p>Upload a clear image of your prescription</p>
              <input type="file" id="prescription" name="prescription" accept="image/*" required style="display: none;">
              <button type="button" class="btn btn-primary mt-3" onclick="document.getElementById('prescription').click()">
                Choose File
              </button>
            </div>
            <div id="filePreview" style="display: none; margin-top: 20px;">
              <img id="previewImage" src="" alt="Preview" style="max-width: 300px; margin-bottom: 10px;">
              <p id="fileName"></p>
              <button type="submit" class="btn btn-success btn-analyze">
                <i class="fas fa-microscope"></i> Analyze Prescription
              </button>
            </div>
          </form>

          <!-- Analysis Results Section -->
          <div id="analysisResults" style="display: none; margin-top: 30px;">
            <h4 class="mb-4">Prescription Analysis Results</h4>
            
            <!-- Patient Info -->
            <div class="info-section mb-4">
              <h5>Patient Information</h5>
              <div class="info-grid">
                <div class="info-item">
                  <label>Patient Name:</label>
                  <span id="patientName"></span>
                </div>
                <div class="info-item">
                  <label>Date:</label>
                  <span id="prescriptionDate"></span>
                </div>
                <div class="info-item">
                  <label>Prescriber:</label>
                  <span id="prescriber"></span>
                </div>
              </div>
            </div>

            <!-- Medicines Table -->
            <div class="medicines-section">
              <h5>Prescribed Medicines</h5>
              <div class="table-responsive">
                <table class="table table-bordered table-hover">
                  <thead class="thead-light">
                    <tr>
                      <th>Medicine Name</th>
                      <th>Dosage</th>
                      <th>Purpose</th>
                      <th>Instructions</th>
                      <th>Warnings</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="medicinesTableBody">
                    <!-- Will be populated by JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Additional Info -->
            <div class="additional-info mt-4">
              <h5>Additional Information</h5>
              <div class="info-grid">
                <div class="info-item">
                  <label>Manufacturer:</label>
                  <span id="manufacturer"></span>
                </div>
                <div class="info-item">
                  <label>Lot Number:</label>
                  <span id="lotNumber"></span>
                </div>
                <div class="info-item">
                  <label>Expiration Date:</label>
                  <span id="expirationDate"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Previous Analyses -->
      <div class="card shadow" style="margin-top: 50px;">
        <div class="card-header py-3">
          <h3 class="m-0 font-weight-bold">Previous Analyses</h3>
        </div>
        <div class="card-body">
          {{if .Prescriptions}}
            <div class="table-responsive">
              <table class="table table-bordered table-hover">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Analysis</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {{range .Prescriptions}}
                  <tr>
                    <td>{{.UploadDate.Format "Jan 02, 2006 15:04"}}</td>
                    <td>
                      <button class="btn btn-link" onclick="showAnalysis('{{.ID.Hex}}')">
                        View Analysis
                      </button>
                    </td>
                    <td>
                      <button class="btn btn-primary btn-sm" onclick="downloadAnalysis('{{.ID.Hex}}')">
                        <i class="fas fa-download"></i> Download
                      </button>
                    </td>
                  </tr>
                  {{end}}
                </tbody>
              </table>
            </div>
          {{else}}
            <p class="text-center">No prescriptions analyzed yet. Upload one to get started!</p>
          {{end}}
        </div>
      </div>
    </div>
  </section>

  <!-- Analysis Modal -->
  <div class="modal" id="analysisModal" style="display: none;">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Prescription Analysis</h2>
      <div id="analysisContent"></div>
    </div>
  </div>

  <!-- AI Chat -->
  <div class="chat-container">
    <button class="chat-toggle btn btn-primary">
      <i class="fas fa-comment-medical"></i>
    </button>
    <div class="chat-modal">
      <div class="chat-header">
        <h4>MedAI Assistant</h4>
        <div class="chat-modes">
          <button class="mode-btn active" data-mode="general" id="general_section">General Health</button>
          <button class="mode-btn" data-mode="disease" id="disease_section">Disease Prediction</button>
        </div>
        <button class="close-chat">&times;</button>
      </div>
      <div class="chat-content">
        <div class="chat-messages"></div>
        <div class="disease-form" style="display: none;">
          <form id="diseaseForm">
            <div class="mb-3">
              <label>Age</label>
              <input type="number" name="age" required>
            </div>
            <div class="mb-3">
              <label>Gender</label>
              <select name="gender" required>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="mb-3">
              <label>Symptoms</label>
              <textarea name="symptoms" rows="2" required></textarea>
            </div>
            <div class="mb-3">
              <label>Medical History</label>
              <textarea name="medical_history" rows="2"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Analyze</button>
          </form>
        </div>
        <div class="chat-input">
          <input type="text" placeholder="Type your health query...">
          <button class="send-btn btn btn-primary">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="footer-top">
        <div class="footer-logo">
          <h2><i class="fas fa-heartbeat"></i> MediMate</h2>
          <p>Quick and efficient doctor appointments at your fingertips</p>
          <div class="social-links">
            <a href="#"><i class="fab fa-facebook-f"></i></a>
            <a href="#"><i class="fab fa-twitter"></i></a>
            <a href="#"><i class="fab fa-instagram"></i></a>
            <a href="#"><i class="fab fa-linkedin-in"></i></a>
          </div>
        </div>
        <div class="footer-links">
          <h3>Quick Links</h3>
          <ul>
            <li><a href="#home">Home</a></li>
            <li><a href="#services">Services</a></li>
            <li><a href="#doctors">Doctors</a></li>
            <li><a href="#about">About Us</a></li>
            <li><a href="#contact">Contact</a></li>
          </ul>
        </div>
        <div class="footer-links">
          <h3>Services</h3>
          <ul>
            <li><a href="#">Find a Doctor</a></li>
            <li><a href="#">Online Consultation</a></li>
            <li><a href="#">Health Checkup</a></li>
            <li><a href="#">Lab Tests</a></li>
            <li><a href="#">Medical Tourism</a></li>
          </ul>
        </div>
        <div class="footer-newsletter">
          <h3>Newsletter</h3>
          <p>Subscribe to our newsletter for health tips and updates</p>
          <form id="newsletterForm">
            <input type="email" placeholder="Your Email" required>
            <button type="submit" class="btn btn-primary">Subscribe</button>
          </form>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 MediMate. Made with ❤️ by Team Malaai (Khusbu Rai & Pushpender Singh).</p>
      </div>
    </div>
  </footer>

  <script src="/static/js/main.js"></script>
  <script>
    // File upload preview
    document.getElementById('prescription').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('previewImage').src = e.target.result;
          document.getElementById('fileName').textContent = file.name;
          document.getElementById('filePreview').style.display = 'block';
          document.getElementById('uploadArea').style.display = 'none';
        }
        reader.readAsDataURL(file);
      }
    });

    // Drag and drop functionality
    const uploadArea = document.getElementById('uploadArea');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults (e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      uploadArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
      uploadArea.classList.add('highlight');
    }

    function unhighlight(e) {
      uploadArea.classList.remove('highlight');
    }

    uploadArea.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const file = dt.files[0];
      document.getElementById('prescription').files = dt.files;
      
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('previewImage').src = e.target.result;
          document.getElementById('fileName').textContent = file.name;
          document.getElementById('filePreview').style.display = 'block';
          document.getElementById('uploadArea').style.display = 'none';
        }
        reader.readAsDataURL(file);
      }
    }

    // Modal functionality
    const modal = document.getElementById('analysisModal');
    const span = document.getElementsByClassName('close')[0];

    span.onclick = function() {
      modal.style.display = 'none';
    }

    window.onclick = function(event) {
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }

    function showAnalysis(id) {
      // Here you would typically fetch the analysis data from the server
      // For now, we'll just show a placeholder
      const analysisContent = document.getElementById('analysisContent');
      analysisContent.innerHTML = 'Loading analysis...';
      modal.style.display = 'block';
      
      fetch(`/prescription/${id}`)
        .then(response => response.json())
        .then(data => {
          analysisContent.innerHTML = formatAnalysis(data, id);
        })
        .catch(error => {
          analysisContent.innerHTML = 'Error loading analysis.';
        });
    }

    function formatAnalysis(data, prescriptionId) {
      try {
        // First try to parse the analysis string into an object
        let analysis;
        try {
          analysis = JSON.parse(data.analysis);
        } catch (e) {
          const cleanJson = data.analysis.replace(/```json\n|\n```/g, '');
          analysis = JSON.parse(cleanJson);
        }

        let html = '<div class="analysis-content">';
        
        // Add action buttons at the top with prescriptionId
        html += `
          <div class="analysis-actions">
            <button onclick="downloadPDF(event, '${prescriptionId}')" class="btn btn-primary btn-sm">
              <i class="fas fa-download"></i> Download PDF
            </button>
            <button onclick="deletePrescription(event, '${prescriptionId}')" class="btn btn-danger btn-sm">
              <i class="fas fa-trash"></i> Delete Analysis
            </button>
          </div>
        `;
        
        // Add patient information
        html += '<div class="patient-info">';
        html += `<h3>Patient Information</h3>`;
        html += `<p><strong>Patient Name:</strong> ${analysis.patient_name || 'Not specified'}</p>`;
        html += `<p><strong>Date:</strong> ${analysis.date || 'Not specified'}</p>`;
        html += `<p><strong>Prescriber:</strong> ${analysis.prescriber || 'Not specified'}</p>`;
        html += '</div>';

        // Add medicines information
        if (analysis.medicines && analysis.medicines.length > 0) {
          html += '<h3>Medicines</h3>';
          html += '<div class="medicines-list">';
          analysis.medicines.forEach((med, index) => {
            const pharmEasyLink = `https://pharmeasy.in/search/all?name=${encodeURIComponent(med.name || '')}`;
            html += `
              <div class="medicine-item">
                <h4>${index + 1}. ${med.name || 'Unknown Medicine'}</h4>
                <ul>
                  <li><strong>Dosage:</strong> ${med.dosage || 'Not specified'}</li>
                  <li><strong>Purpose:</strong> ${med.purpose || 'Unknown'}</li>
                  <li><strong>Instructions:</strong> ${med.instructions || 'Not specified'}</li>
                  ${med.warnings ? `<li><strong>Warnings:</strong> ${med.warnings}</li>` : ''}
                  ${med.generic_alternatives ? `
                    <li>
                      <strong>Generic Alternatives:</strong>
                      <ul class="generic-list">
                        ${med.generic_alternatives.map(alt => `
                          <li>
                            ${alt.name} (${alt.cost_saving}% cheaper)
                            <a href="https://pharmeasy.in/search/all?name=${encodeURIComponent(alt.name)}" 
                               target="_blank" 
                               class="btn btn-outline-primary btn-sm">
                              <i class="fas fa-shopping-cart"></i> Buy Generic
                            </a>
                          </li>
                        `).join('')}
                      </ul>
                    </li>
                  ` : ''}
                  ${med.dosage_appropriate ? 
                    `<li><strong>Dosage Status:</strong> <span class="status-badge ${
                      med.dosage_appropriate.toLowerCase() === 'suspicious' ? 'status-suspicious' : 'status-appropriate'
                    }">${med.dosage_appropriate}</span></li>` : 
                    ''}
                  <li class="buy-medicine">
                    <a href="${pharmEasyLink}" target="_blank" class="btn btn-primary btn-sm">
                      <i class="fas fa-shopping-cart"></i> Buy on PharmEasy
                    </a>
                  </li>
                </ul>
              </div>
            `;
          });
          html += '</div>';
        }

        // Add dietary recommendations
        if (analysis.dietary_recommendations) {
          html += '<div class="dietary-recommendations">';
          html += '<h3>Dietary Recommendations</h3>';
          html += '<div class="diet-grid">';
          
          // Foods to Eat
          html += `
            <div class="diet-section foods-to-eat">
              <h4><i class="fas fa-check-circle"></i> Foods to Eat</h4>
              <ul>
                ${analysis.dietary_recommendations.foods_to_eat.map(food => 
                  `<li><i class="fas fa-utensils"></i> ${food}</li>`
                ).join('')}
              </ul>
            </div>
          `;

          // Foods to Avoid
          html += `
            <div class="diet-section foods-to-avoid">
              <h4><i class="fas fa-times-circle"></i> Foods to Avoid</h4>
              <ul>
                ${analysis.dietary_recommendations.foods_to_avoid.map(food => 
                  `<li><i class="fas fa-ban"></i> ${food}</li>`
                ).join('')}
              </ul>
            </div>
          `;

          html += '</div>'; // Close diet-grid
          html += '</div>'; // Close dietary-recommendations
        }

        // Add additional information
        html += '<div class="additional-info">';
        html += '<h3>Additional Information</h3>';
        html += `<p><strong>Manufacturer:</strong> ${analysis.manufacturer || 'Not specified'}</p>`;
        html += `<p><strong>Lot Number:</strong> ${analysis.lot_number || 'Not specified'}</p>`;
        html += `<p><strong>Expiration Date:</strong> ${analysis.expiration_date || 'Not specified'}</p>`;
        html += '</div>';

        return html;
      } catch (e) {
        console.error('Error parsing analysis:', e);
        return `
          <div class="error-message">
            <h3>Error Displaying Analysis</h3>
            <p>There was an error displaying the prescription analysis. Please try again or contact support if the problem persists.</p>
            <p>Error details: ${e.message}</p>
          </div>
        `;
      }
    }

    function downloadAnalysis(id) {
      fetch(`/prescription/${id}/download`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.blob();
        })
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `prescription-analysis-${id}.pdf`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
        })
        .catch(error => {
          console.error('Error downloading analysis:', error);
          alert('Error downloading the analysis. Please try again.');
        });
    }

    function handlePrescriptionSubmit(event) {
      event.preventDefault();
      
      const form = event.target;
      const formData = new FormData(form);
      const loadingSpinner = document.createElement('div');
      loadingSpinner.className = 'loading-spinner';
      loadingSpinner.innerHTML = '<i class="fas fa-spinner fa-spin"></i><p>Analyzing prescription...</p>';
      
      // Hide previous results if any
      document.getElementById('analysisResults').style.display = 'none';
      
      // Show loading spinner
      form.appendChild(loadingSpinner);
      loadingSpinner.style.display = 'block';

      fetch('/analyze-prescription', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        loadingSpinner.remove();
        displayNewAnalysis(data.analysis);
      })
      .catch(error => {
        loadingSpinner.remove();
        alert('Error analyzing prescription. Please try again.');
        console.error('Error:', error);
      });
    }

    function displayNewAnalysis(data) {
  console.log('Received data in displayNewAnalysis:', data); // Log the input data
  try {
    // Check if data and data.analysis exist
    if (!data) {
      throw new Error('Invalid or missing analysis data in server response');
    }

    // Parse the analysis data
    let analysis;
    try {
      // First try parsing directly
      analysis = JSON.parse(data);
    } catch (e) {
      console.error('Direct JSON parse failed:', e);
      // Try cleaning markdown and parsing again
      const cleanJson = data.replace(/```json|```/g, '').trim();
      analysis = JSON.parse(cleanJson);
    }

    // Get the analysisResults section
    const analysisResults = document.getElementById('analysisResults');
    if (!analysisResults) {
      throw new Error('Analysis results section not found in DOM');
    }

    // Populate Patient Information
    document.getElementById('patientName').textContent = analysis.patient_name || 'Not specified';
    document.getElementById('prescriptionDate').textContent = analysis.date || 'Not specified';
    document.getElementById('prescriber').textContent = analysis.prescriber || 'Not specified';

    // Populate Medicines Table
    const medicinesTableBody = document.getElementById('medicinesTableBody');
    medicinesTableBody.innerHTML = ''; // Clear existing rows
    if (analysis.medicines && Array.isArray(analysis.medicines)) {
      analysis.medicines.forEach(med => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${med.name || 'Unknown'}</td>
          <td>${med.dosage || 'Not specified'}</td>
          <td>${med.purpose || 'Unknown'}</td>
          <td>${med.instructions || 'Not specified'}</td>
          <td>${med.warnings || 'None'}</td>
          <td>
            <span class="status-badge ${
              med.dosage_appropriate && med.dosage_appropriate.toLowerCase() === 'suspicious' 
              ? 'status-suspicious' 
              : 'status-appropriate'
            }">
              ${med.dosage_appropriate || 'Not checked'}
            </span>
          </td>
        `;
        medicinesTableBody.appendChild(row);
      });
    } else {
      medicinesTableBody.innerHTML = '<tr><td colspan="6">No medicines found.</td></tr>';
    }

    // Populate Additional Information
    document.getElementById('manufacturer').textContent = analysis.manufacturer || 'Not specified';
    document.getElementById('lotNumber').textContent = analysis.lot_number || 'Not specified';
    document.getElementById('expirationDate').textContent = analysis.expiration_date || 'Not specified';

    // Show the analysis results section
    analysisResults.style.display = 'block';

    // Scroll to the results
    analysisResults.scrollIntoView({ behavior: 'smooth' });
  } catch (error) {
    console.error('Error displaying analysis:', error);
    showAlert(`Error displaying prescription analysis: ${error.message}. Please try again.`, 'danger');
  }
}

    // Update downloadPDF function to use the correct route
    async function downloadPDF(event, prescriptionId) {
      event.preventDefault();
      if (!prescriptionId) {
        showAlert('Invalid prescription ID', 'danger');
        return;
      }

      try {
        const response = await fetch(`/prescription/${prescriptionId}/download`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        // Create a blob from the PDF stream
        const blob = await response.blob();
        // Create a link to download the blob
        const downloadUrl = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = `prescription-${prescriptionId}.pdf`;

        // Append to the document, click it, and remove it
        document.body.appendChild(link);
        link.click();
        link.remove();

        // Clean up the URL object
        window.URL.revokeObjectURL(downloadUrl);
      } catch (error) {
        console.error('Error:', error);
        showAlert('Error downloading PDF. Please try again.', 'danger');
      }
    }

    // Update delete function to handle the event properly
    async function deletePrescription(event, prescriptionId) {
      event.preventDefault();
      if (!prescriptionId) {
        showAlert('Invalid prescription ID', 'danger');
        return;
      }

      if (!confirm('Are you sure you want to delete this prescription analysis? This action cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch(`/delete-prescription?id=${prescriptionId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          },
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
        }

        // Show success message
        showAlert('Prescription deleted successfully', 'success');

        // Wait for a short moment to show the success message
        setTimeout(() => {
          // Refresh the page
          window.location.reload();
        }, 1000);

      } catch (error) {
        console.error('Error:', error);
        showAlert(`Error deleting prescription: ${error.message}`, 'danger');
      }
    }

    // Add showAlert function if not already present
    function showAlert(message, type) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
      alertDiv.role = 'alert';
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      
      // Insert at the top of the content area
      const contentArea = document.querySelector('.container');
      contentArea.insertBefore(alertDiv, contentArea.firstChild);
      
      // Auto dismiss after 5 seconds
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }

    // Update displayPrescription function to pass the correct ID
    function displayPrescription(data) {
      const prescriptionsList = document.getElementById('prescriptionsList');
      const card = document.createElement('div');
      card.className = 'card mb-4 prescription-card';
      card.setAttribute('data-prescription-id', data._id);
      
      let uploadDate;
      try {
        uploadDate = new Date(data.uploadDate).toLocaleDateString();
      } catch (e) {
        uploadDate = 'Unknown date';
      }
      
      card.innerHTML = `
        <div class="card-header d-flex justify-content-between align-items-center mb-10">
          <span>Analysis from ${uploadDate}</span>
        </div>
        <div class="card-body">
          ${formatAnalysis(data, data._id)}
        </div>
      `;
      
      prescriptionsList.appendChild(card);
    }
  </script>

  <style>
    .upload-area {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .upload-area.highlight {
      border-color: #4e73df;
      background-color: rgba(78, 115, 223, 0.1);
    }

    .btn-analyze {
      padding: 10px 20px;
      font-size: 1.1em;
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 20px auto;
    }

    .info-section {
      background: #f8f9fc;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 15px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .info-item label {
      font-weight: 600;
      color: #4e73df;
    }

    .medicines-section {
      margin-top: 30px;
    }

    .table thead th {
      background-color: #4e73df;
      color: white;
      font-weight: 500;
    }

    .status-badge {
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.85em;
      font-weight: 500;
    }

    .status-suspicious {
      background-color: #ffebee;
      color: #c62828;
    }

    .status-appropriate {
      background-color: #e8f5e9;
      color: #2e7d32;
    }

    .loading-spinner {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .loading-spinner i {
      font-size: 2em;
      color: #4e73df;
    }

    /* Analysis Modal Styles */
    .analysis-content {
      padding: 20px;
    }

    .patient-info, .additional-info {
      background: #f8f9fc;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .medicines-list {
      display: grid;
      gap: 20px;
      margin: 15px 0;
    }

    .medicine-item {
      background: #fff;
      border: 1px solid #e3e6f0;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .medicine-item h4 {
      color: #4e73df;
      margin-bottom: 10px;
      border-bottom: 1px solid #e3e6f0;
      padding-bottom: 8px;
    }

    .medicine-item ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .medicine-item li {
      margin: 8px 0;
    }

    .error-message {
      background: #fff3f3;
      border: 1px solid #ffcdd2;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }

    .error-message h3 {
      color: #c62828;
      margin-bottom: 10px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 20px;
      border-radius: 8px;
      width: 80%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    .close {
      position: absolute;
      right: 20px;
      top: 15px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: #666;
    }

    .close:hover {
      color: #333;
    }

    .buy-medicine {
      margin-top: 12px !important;
    }

    .buy-medicine .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background-color: #10847e;
      border-color: #10847e;
      transition: all 0.3s ease;
    }

    .buy-medicine .btn:hover {
      background-color: #0d6d68;
      border-color: #0d6d68;
      transform: translateY(-1px);
    }

    .buy-medicine .btn i {
      font-size: 0.9em;
    }

    .generic-list {
      margin-top: 8px;
      margin-left: 20px;
    }

    .generic-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 5px 0;
      padding: 5px;
      background: #f8f9fa;
      border-radius: 4px;
    }

    .btn-outline-primary {
      color: #10847e;
      border-color: #10847e;
      background-color: transparent;
      margin-left: 10px;
    }

    .btn-outline-primary:hover {
      color: white;
      background-color: #10847e;
    }

    .dietary-recommendations {
      background: #fff;
      border: 1px solid #e3e6f0;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .diet-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 15px;
    }

    .diet-section {
      background: #f8f9fc;
      padding: 15px;
      border-radius: 8px;
    }

    .diet-section h4 {
      color: #4e73df;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .foods-to-eat h4 {
      color: #1cc88a;
    }

    .foods-to-avoid h4 {
      color: #e74a3b;
    }

    .diet-section ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .diet-section li {
      margin: 8px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .foods-to-eat li i {
      color: #1cc88a;
    }

    .foods-to-avoid li i {
      color: #e74a3b;
    }

    .analysis-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .btn-danger {
      background-color: #dc3545;
      border-color: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background-color: #c82333;
      border-color: #bd2130;
    }

    .alert {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1050;
      min-width: 300px;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    .alert-success {
      color: #155724;
      background-color: #d4edda;
      border-color: #c3e6cb;
    }

    .alert-danger {
      color: #721c24;
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }
  </style>
</body>
</html>
{{end}}